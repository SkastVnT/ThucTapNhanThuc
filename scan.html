<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <title>Scan QR Code</title>
    <link rel="stylesheet" href="styles.css">

    <!-- <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #calendar-container-insert {
            margin: 20px auto;
            max-width: 300px;
        }
        button:disabled {
            background-color: #ccc;
        }
        button {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:enabled:hover {
            background-color: #0056b3;
        }
    </style> -->
</head>
<body>
    <div id="loader" style="display: none;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    <div style="margin: 10px 0;">
        <label for="filter-name">L·ªçc theo khu v·ª±c:</label>
        <select id="filter-name">
          <option value="all">Hi·ªán th·ªã t·∫•t c·∫£</option>
          <option value="KHO CH√çNH">KHO CH√çNH</option>
          <option value="XUNG QUANH">XUNG QUANH</option>
          <option value="VƒÇN PH√íNG">VƒÇN PH√íNG</option>
          <option value="KHO ƒê√îNG">KHO ƒê√îNG</option>
          <option value="WC">WC</option>
          <option value="DV V·ªÜ SINH">DV V·ªÜ SINH</option>
          <option value="DV BAO VE">DV BAO VE</option>
        </select>
      </div>
      
    <div class="task-container">
        <div id="checklist-container"></div>
        <div id="task-list">
            <!-- Danh s√°ch c√¥ng vi·ªác s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
        </div>
    </div>
    
     <!-- N∆°i hi·ªÉn th·ªã checklist -->
    
    <!-- <div id="reader" style="width: 300px; height: 300px;"></div> -->
    <!-- <button id="scan-btn">B·∫Øt ƒë·∫ßu qu√©t</button> -->
    <button id="rescan-btn" style="display: none;">Qu√©t l·∫°i</button>

   <!-- C√°c ph·∫ßn kh√°c c·ªßa scan.html ... -->
   <!-- <button id="back-btn">‚¨Ö Quay l·∫°i</button> -->
   <script>
     document.getElementById("back-btn").addEventListener("click", function () {
         // T·∫°m th·ªùi t·∫Øt auto chuy·ªÉn h∆∞·ªõng cho phi√™n l√†m vi·ªác hi·ªán t·∫°i
         sessionStorage.setItem("disableAutoTransfer", "true");
         window.location.href = "index.html";
     });
   </script>
   

    <button id="refresh-btn">üîÑ L√†m m·ªõi trang</button>

    <script>
        document.getElementById("refresh-btn").addEventListener("click", function () {
            location.reload(); // L√†m m·ªõi trang
        });
    </script>
    <h3>üóëÔ∏è X√≥a M·ª•c:</h3>
    <select id="delete-select">
        <option value="">-- Ch·ªçn m·ª•c ƒë·ªÉ x√≥a --</option>
    </select>
    <button id="delete-btn" disabled>‚ùå X√≥a</button>
    

    <div id="reader"></div>
    <div id="checklist-container"></div>
    <button id="export-all-btn">üìÑ Xu·∫•t Excel</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="script.js"></script>
    <!-- Ph·∫ßn n√†y ƒë∆∞·ª£c th√™m v√†o scan.html ƒë·ªÉ cho ph√©p ng∆∞·ªùi d√πng insert "C√îNG VI·ªÜC KH√ÅC" -->
    <div id="insert-panel" style="margin: 20px; padding: 10px; border: 1px solid #ccc;">
        <h3>Th√™m c√¥ng vi·ªác kh√°c:</h3>
        <div class="insert-form">
          <label for="custom-job">Nh·∫≠p c√¥ng vi·ªác kh√°c:</label>
          <input type="text" id="custom-job" placeholder="Nh·∫≠p t√™n c√¥ng vi·ªác kh√°c" style="margin-bottom:10px;" />
          <br />
          <label for="name-select">Ch·ªçn khu v·ª±c mu·ªën th√™m:</label>
          <select id="name-select">
            <option value="KHO CH√çNH">KHO CH√çNH</option>
            <option value="XUNG QUANH">XUNG QUANH</option>
            <option value="VƒÇN PH√íNG">VƒÇN PH√íNG</option>
            <option value="KHO ƒê√îNG">KHO ƒê√îNG</option>
            <option value="WC">WC</option>
            <option value="DV V·ªÜ SINH">DV V·ªÜ SINH</option>
            <option value="DV BAO VE">DV BAO VE</option>
            <option value="other">C√îNG VI·ªÜC KH√ÅC</option>
          </select>
          <br />
          <!-- Container cho nh·∫≠p t√™n n·∫øu ch·ªçn "other" -->
          <div id="custom-name-container" style="display: none; margin-top:10px;">
            <label for="custom-name">Nh·∫≠p C√îNG VI·ªÜC KH√ÅC:</label>
            <input type="text" id="custom-name" placeholder="Nh·∫≠p t√™n c√¥ng vi·ªác kh√°c" />
          </div>
          <br />
          <button id="insert-other-btn">‚ûï Th√™m d·ªØ li·ªáu</button>
        </div>
      </div>
    
      <!-- Script x·ª≠ l√Ω s·ª± ki·ªán th√™m d·ªØ li·ªáu -->
      <script>
        // H√†m l·∫•y m·ªëc th·ªùi gian theo ƒë·ªãnh d·∫°ng "YYYY-MM-DD HH:00:00"
        function getThresholdTimestamp() {
          const now = new Date();
          const currentHour = now.getHours();
          let targetHour;
          if (currentHour < 13) {
            targetHour = 10;
          } else if (currentHour < 16) {
            targetHour = 13;
          } else {
            targetHour = 16;
          }
          const year = now.getFullYear();
          const month = ("0" + (now.getMonth() + 1)).slice(-2);
          const day = ("0" + now.getDate()).slice(-2);
          return `${year}-${month}-${day} ${("0" + targetHour).slice(-2)}:00:00`;
        }
    
        // H√†m l·∫•y timestamp hi·ªán t·∫°i theo ƒë·ªãnh d·∫°ng "YYYY-MM-DD HH:MM:SS"
        function getCurrentTimestamp() {
          const now = new Date();
          const year = now.getFullYear();
          const month = ("0" + (now.getMonth() + 1)).slice(-2);
          const day = ("0" + now.getDate()).slice(-2);
          const hour = ("0" + now.getHours()).slice(-2);
          const minute = ("0" + now.getMinutes()).slice(-2);
          const second = ("0" + now.getSeconds()).slice(-2);
          return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
        }
    
        document.addEventListener("DOMContentLoaded", function () {
          const insertBtn = document.getElementById("insert-other-btn");
          const nameSelect = document.getElementById("name-select");
    
          // Khi thay ƒë·ªïi gi√° tr·ªã c·ªßa select, hi·ªÉn th·ªã h·ªôp nh·∫≠p n·∫øu ch·ªçn "other"
          nameSelect.addEventListener("change", function () {
            const customNameContainer = document.getElementById("custom-name-container");
            if (this.value === "other") {
              customNameContainer.style.display = "block";
            } else {
              customNameContainer.style.display = "none";
            }
          });
    
          insertBtn.addEventListener("click", function () {
            const customJob = document.getElementById("custom-job").value.trim();
            if (!customJob) {
              alert("Vui l√≤ng nh·∫≠p c√¥ng vi·ªác kh√°c!");
              return;
            }
            let name = nameSelect.value;
            if (name === "other") {
              const customName = document.getElementById("custom-name").value.trim();
              if (!customName) {
                alert("Vui l√≤ng nh·∫≠p t√™n khu v·ª±c cho c√¥ng vi·ªác kh√°c!");
                return;
              }
              name = customName;
            }
            const timestamp = getThresholdTimestamp();
            const nowTimestamp = getCurrentTimestamp();
            const id = Math.floor(100000 + Math.random() * 900000);
            const code = `${name}-${customJob}`;
    
            console.log("ƒêang th√™m d·ªØ li·ªáu:", { id, name, type: customJob, today: timestamp, code, createdAt: nowTimestamp, updatedAt: nowTimestamp });
    
            fetch("api/insert.php", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({
                id,
                name,
                type: customJob,
                today: timestamp,
                code,
                createdAt: nowTimestamp,
                updatedAt: nowTimestamp
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert("Th√™m d·ªØ li·ªáu th√†nh c√¥ng!");
                location.reload();
              } else {
                alert("L·ªói khi th√™m d·ªØ li·ªáu: " + data.error);
              }
            })
            .catch(error => {
              console.error("L·ªói khi g·ª≠i request:", error);
              alert("C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.");
            });
          });
        });
      </script>

<script src="delete.js"></script> <!-- Th√™m file x·ª≠ l√Ω x√≥a -->
<!-- N√∫t xu·∫•t t·∫•t c·∫£ d·ªØ li·ªáu -->
<!-- <button id="export-all-btn">üìÑ Export T·∫•t C·∫£</button> -->

<script>
    document.getElementById("export-all-btn").addEventListener("click", async function () {
      console.log("üìÑ ƒêang t·∫£i d·ªØ li·ªáu t·∫•t c·∫£ ƒë·ªÉ xu·∫•t Excel...");
      try {
        const response = await fetch("api/export.php");
        if (!response.ok) throw new Error(`L·ªói HTTP: ${response.status}`);
        const data = await response.json();
        if (!Array.isArray(data) || data.length === 0) {
          alert("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.");
          return;
        }
        console.log("‚úÖ D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);
  
        const desiredOrder = ["id", "NAME", "TYPE", "TODAY", "createdAt", "updatedAt", "STATUS"];
        const formattedData = data.map(row => ({
          id: row.id,
          NAME: row.NAME,
          TYPE: row.TYPE,
          TODAY: row.TODAY,
          createdAt: row.createdAt,
          updatedAt: row.updatedAt,
          STATUS: row.STATUS
        }));
  
        const headers = [
          "id",
          "Khu v·ª±c",
          "C√¥ng vi·ªác",
          "D·ª± ki·∫øn",
          "Danh s√°ch ƒë√£ ƒë∆∞·ª£c t·∫°o",
          "Th·ªùi gian ki·ªÉm tra",
          "Tr·∫°ng th√°i"
        ];
  
        const rows = formattedData.map(row =>
          desiredOrder.map(key => row[key] !== undefined ? row[key] : "")
        );
  
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  
        const range = XLSX.utils.decode_range(ws["!ref"]);
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const colLetter = XLSX.utils.encode_col(C);
          for (let R = range.s.r; R <= range.e.r; ++R) {
            const cellAddress = colLetter + XLSX.utils.encode_row(R);
            if (ws[cellAddress] && ws[cellAddress].t) {
              ws[cellAddress].s = { alignment: { horizontal: "left" } };
            }
          }
        }
  
        ws["!cols"] = headers.map((header, i) => {
          const colWidth = Math.max(header.length, ...rows.map(r => r[i].toString().length)) + 2;
          return { wch: colWidth };
        });
  
        XLSX.utils.book_append_sheet(wb, ws, "To√†n B·ªô D·ªØ Li·ªáu");
        XLSX.writeFile(wb, `DanhSachToanBo.xlsx`);
  
        alert("‚úÖ Xu·∫•t Excel th√†nh c√¥ng!");
      } catch (error) {
        console.error("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
        alert("‚ùå L·ªói khi xu·∫•t d·ªØ li·ªáu, vui l√≤ng th·ª≠ l·∫°i.");
      }
    });
  </script>

</body>
</html>
